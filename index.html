import React, { useState, useRef, useEffect } from 'react';
import { Download, User, BarChart3, MessageSquare, RefreshCw, FileText, Printer, CheckCircle2, Sparkles, Loader2 } from 'lucide-react';

const App = () => {
  const apiKey = ""; // API Key disediakan oleh environment
  
  const [formData, setFormData] = useState({
    namaLengkap: 'Clarissa Amarullah Shidiq',
    namaPanggilan: 'Clarissa',
    skor: {
      artikulasi: 3,
      engagement: 3,
      ekspresi: 3,
      inklusivitas: 2,
      kecemasan: 3
    },
    rawNotes: 'Clarissa sudah berani maju. Suara kadang pelan kadang keras (belum stabil). Sudah mulai ada gesture tangan. Tapi kalau diskusi grup masih sering diam/pasif. Perlu dilatih voice levelnya.',
    nilaiAkhir: 70
  });

  const [paragraphs, setParagraphs] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const reportRef = useRef(null);

  // Load html2pdf script dynamically
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    script.async = true;
    document.head.appendChild(script);
    return () => {
      if (document.head.contains(script)) {
        document.head.removeChild(script);
      }
    };
  }, []);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSkorChange = (aspek, val) => {
    setFormData(prev => ({
      ...prev,
      skor: { ...prev.skor, [aspek]: parseInt(val) }
    }));
  };

  const generateReportWithAI = async () => {
    setIsGenerating(true);
    const systemPrompt = `
      Anda adalah seorang instruktur Public Speaking profesional di YEC.CO.ID.
      Tugas Anda adalah membuat laporan observasi bulanan berdasarkan data skor dan catatan mentah.
      
      KRITERIA PENULISAN:
      1. Terdiri dari MAKSIMAL 6 paragraf.
      2. Bahasa: Indonesia, Formal, Profesional, Tajam, Kritis, Analitis, namun tetap Soft-Spoken (manusiawi).
      3. JANGAN mengglorifikasi atau berlebihan.
      4. Setiap paragraf harus mengaitkan aspek penilaian dengan indikator teknis.
      5. Sertakan contoh konkret atau analisis detail.
      6. Paragraf terakhir harus berisi Kesimpulan dan Rekomendasi.
      7. Gunakan nama panggilan saja (${formData.namaPanggilan}) tanpa embel-embel 'Ananda'.
      
      PENONJOLAN TEKS (PENTING):
      Identifikasi kata kunci atau frasa penting dan bungkus dengan tag HTML berikut:
      - <strong>Teks</strong> untuk cetak tebal.
      - <span class="hl-blue">Teks</span> untuk informasi progres/netral (biru).
      - <span class="hl-green">Teks</span> untuk kelebihan/aspek positif (hijau).
      - <span class="hl-red">Teks</span> untuk kelemahan/masalah kritis (merah).
      - <span class="hl-yellow">Teks</span> untuk perhatian khusus/rekomendasi (kuning).
      
      ASPEK & SKOR (1-4):
      - Artikulasi & Proyeksi: ${formData.skor.artikulasi}
      - Interaction & Engagement: ${formData.skor.engagement}
      - Ekspresi & Penguasaan Ruang: ${formData.skor.ekspresi}
      - Inklusivitas & Kontrol Kelompok: ${formData.skor.inklusivitas}
      - Manajemen Kecemasan: ${formData.skor.kecemasan}
      
      CATATAN MENTAH DARI INSTRUKTUR:
      "${formData.rawNotes}"
      
      Output harus dalam format JSON: { "paragraphs": ["teks dengan tag HTML", "teks dengan tag HTML", ...] }
    `;

    let retries = 0;
    const maxRetries = 5;
    
    const attemptFetch = async () => {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "Gunakan instruksi sistem untuk membuat laporan." }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { responseMimeType: "application/json" }
          })
        });

        if (!response.ok) throw new Error('API Error');
        const result = await response.json();
        const data = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
        if (data.paragraphs) setParagraphs(data.paragraphs);
      } catch (error) {
        if (retries < maxRetries) {
          retries++;
          await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
          return attemptFetch();
        }
        alert("Gagal mengelaborasi catatan. Silakan coba lagi.");
      }
    };

    await attemptFetch();
    setIsGenerating(false);
  };

  useEffect(() => {
    generateReportWithAI();
  }, []);

  const downloadPDF = () => {
    if (!window.html2pdf) {
      alert("Sistem PDF sedang dimuat...");
      return;
    }
    const element = reportRef.current;
    const opt = {
      margin: 0,
      filename: `Report_${formData.namaPanggilan}_YEC.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    window.html2pdf().set(opt).from(element).save();
  };

  return (
    <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sans text-slate-900">
      <style>{`
        .hl-blue { background-color: #dbeafe; color: #1e40af; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        .hl-red { background-color: #fee2e2; color: #991b1b; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        .hl-green { background-color: #dcfce7; color: #166534; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        .hl-yellow { background-color: #fef9c3; color: #854d0e; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        strong { font-weight: 700; color: #1e293b; }
      `}</style>
      
      <div className="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
        
        {/* PANEL INPUT */}
        <div className="lg:w-1/3 space-y-6 no-print">
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-xl font-bold flex items-center gap-2 mb-6 text-blue-900 border-b pb-2">
              <User size={20} /> Profil Peserta
            </h2>
            <div className="space-y-4">
              <input 
                placeholder="Nama Lengkap"
                className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                name="namaLengkap" value={formData.namaLengkap} onChange={handleInputChange}
              />
              <input 
                placeholder="Nama Panggilan"
                className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                name="namaPanggilan" value={formData.namaPanggilan} onChange={handleInputChange}
              />
              <input 
                type="number" placeholder="Nilai Akhir (0-100)"
                className="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                name="nilaiAkhir" value={formData.nilaiAkhir} onChange={handleInputChange}
              />
            </div>
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-xl font-bold flex items-center gap-2 mb-6 text-blue-900 border-b pb-2">
              <BarChart3 size={20} /> Skor Aspek (1-4)
            </h2>
            <div className="space-y-4">
              {Object.keys(formData.skor).map(key => (
                <div key={key} className="flex items-center justify-between">
                  <label className="text-xs font-bold text-slate-500 uppercase">{key}</label>
                  <div className="flex gap-1">
                    {[1, 2, 3, 4].map(n => (
                      <button
                        key={n}
                        onClick={() => handleSkorChange(key, n)}
                        className={`w-8 h-8 rounded-md text-xs font-bold transition ${formData.skor[key] === n ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-400'}`}
                      >
                        {n}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-xl font-bold flex items-center gap-2 mb-6 text-blue-900 border-b pb-2">
              <MessageSquare size={20} /> Observasi Mentah
            </h2>
            <textarea 
              className="w-full px-3 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 h-40 resize-none"
              placeholder="Tulis poin-poin singkat di sini..."
              value={formData.rawNotes} 
              onChange={(e) => setFormData({...formData, rawNotes: e.target.value})}
            />
            
            <button 
              onClick={generateReportWithAI}
              disabled={isGenerating}
              className="w-full mt-6 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2 shadow-lg"
            >
              {isGenerating ? <Loader2 className="animate-spin" size={20} /> : <Sparkles size={20} />}
              {isGenerating ? "Menganalisis..." : "Elaborasi Otomatis"}
            </button>
          </div>
        </div>

        {/* PANEL PREVIEW */}
        <div className="flex-1 bg-white rounded-3xl overflow-hidden shadow-2xl min-h-[1100px] border border-slate-200 relative">
          
          <div className="absolute top-6 right-6 z-50 no-print flex gap-2">
             <button onClick={downloadPDF} className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-full shadow-lg transition flex items-center gap-2 font-bold text-sm">
                <Download size={18} /> Unduh PDF
             </button>
          </div>

          <div ref={reportRef} className="relative bg-white min-h-full">
            {/* Watermark */}
            <div className="absolute inset-0 pointer-events-none overflow-hidden flex flex-col justify-around items-center opacity-[0.03] z-0">
               {[1,2,3,4,5].map(i => <div key={i} className="text-[9rem] font-black -rotate-[35deg] whitespace-nowrap">YEC.CO.ID</div>)}
            </div>

            <div className="relative z-10">
              <div className="bg-gradient-to-br from-[#1e3a8a] to-[#3b82f6] p-16 text-center text-white">
                <h1 className="text-4xl md:text-5xl font-serif font-bold mb-3">Monthly Observation Report</h1>
                <div className="inline-block px-4 py-1 bg-white/20 rounded-full tracking-[0.2em] uppercase text-xs font-semibold text-blue-50">
                  Public Speaking Anak Reguler
                </div>
              </div>

              <div className="grid grid-cols-2 p-10 bg-slate-50 border-b border-slate-100">
                <div className="border-r border-slate-200 pr-4">
                  <p className="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-1">Nama Lengkap</p>
                  <p className="text-2xl font-bold text-slate-800 leading-tight">{formData.namaLengkap}</p>
                </div>
                <div className="pl-10">
                  <p className="text-[10px] text-slate-400 uppercase font-black tracking-widest mb-1">Nama Panggilan</p>
                  <p className="text-2xl font-bold text-blue-700 leading-tight">{formData.namaPanggilan}</p>
                </div>
              </div>

              <div className="p-10">
                <h2 className="font-serif text-2xl font-bold text-slate-800 mb-8 border-l-4 border-blue-600 pl-4">Rincian Capaian Aspek</h2>
                <div className="grid grid-cols-1 gap-6">
                  {Object.entries({
                    "Artikulasi & Proyeksi Suara": formData.skor.artikulasi,
                    "Interaksi & Respons (Engagement)": formData.skor.engagement,
                    "Ekspresi & Penguasaan Ruang": formData.skor.ekspresi,
                    "Inklusivitas & Kontrol Kelompok": formData.skor.inklusivitas,
                    "Manajemen Kecemasan": formData.skor.kecemasan,
                  }).map(([label, val]) => (
                    <div key={label}>
                      <div className="flex justify-between mb-1 items-end">
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-tighter">{label}</span>
                        <span className="text-xs font-black bg-slate-100 px-2 rounded border border-slate-200">{val} / 4</span>
                      </div>
                      <div className="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden border border-slate-100">
                        <div 
                          className={`h-full transition-all duration-1000 ${val === 4 ? 'bg-emerald-500' : val === 3 ? 'bg-blue-500' : val === 2 ? 'bg-yellow-500' : 'bg-red-500'}`} 
                          style={{ width: `${(val/4)*100}%` }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-12 bg-blue-50/50 p-8 rounded-3xl flex items-center justify-between border border-blue-100">
                  <span className="text-blue-900 font-bold text-xl uppercase italic">Nilai Akhir Bulan Ini</span>
                  <div className="text-right">
                    <span className="text-6xl font-black text-blue-900 tracking-tighter">{formData.nilaiAkhir}<span className="text-2xl font-light text-blue-400 ml-1">/100</span></span>
                  </div>
                </div>
              </div>

              <div className="p-10 bg-white border-t border-slate-100">
                <h2 className="font-serif text-2xl font-bold text-slate-800 mb-8 border-l-4 border-blue-600 pl-4">Catatan Penilaian & Analisis</h2>
                
                {isGenerating ? (
                  <div className="flex flex-col items-center justify-center py-24 text-slate-400 animate-pulse">
                    <Sparkles size={48} className="mb-4 text-blue-200" />
                    <p className="text-sm font-medium">Sistem sedang merangkai narasi laporan...</p>
                  </div>
                ) : (
                  <div className="space-y-8 text-slate-600 text-[15px] leading-[1.9] text-justify font-light">
                    {paragraphs.map((para, idx) => (
                      <p key={idx} className="relative pl-6 before:content-[''] before:absolute before:left-0 before:top-3 before:w-1.5 before:h-1.5 before:bg-blue-300 before:rounded-full" 
                         dangerouslySetInnerHTML={{ __html: para }} 
                      />
                    ))}
                  </div>
                )}
              </div>

              <div className="p-16 bg-slate-50 border-t border-slate-100 flex flex-col md:flex-row justify-between items-end gap-8">
                <div className="space-y-4">
                  <div className="flex items-center gap-2 text-blue-600">
                    <CheckCircle2 size={16} />
                    <span className="text-[10px] font-bold uppercase tracking-widest">Verified Academic Report</span>
                  </div>
                  <p className="text-[11px] text-slate-400 italic max-w-xs leading-relaxed">
                    Laporan ini disusun secara profesional oleh tim instruktur YEC.CO.ID untuk memantau perkembangan kompetensi komunikasi anak.
                  </p>
                </div>
                <div className="text-center">
                  <div className="w-48 h-px bg-slate-300 mb-3 mx-auto"></div>
                  <p className="text-xs font-black text-slate-700 uppercase tracking-widest">Instruktur Public Speaking</p>
                  <p className="text-[10px] text-slate-400 mt-1">YEC.CO.ID Professional Education</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
