import React, { useState, useRef, useEffect } from 'react';
import { 
  Download, User, BarChart3, MessageSquare, 
  RefreshCw, FileText, Printer, CheckCircle2, 
  Sparkles, Loader2, Trash2, Github, Share2 
} from 'lucide-react';

/**
 * YEC REPORT GENERATOR - TEAM VERSION
 * * CARA PUBLIKASI DI GITHUB:
 * 1. Buat repositori baru di GitHub.
 * 2. Masukkan kode ini ke dalam file bernama 'App.jsx' (jika menggunakan Vite) 
 * atau sesuaikan dengan boilerplate React Anda.
 * 3. Masukkan API Key pada variabel 'apiKey' di bawah ini.
 * 4. Deploy menggunakan GitHub Pages, Vercel, atau Netlify.
 */

const App = () => {
  // Masukkan Gemini API Key Anda di sini untuk penggunaan tim
  const apiKey = ""; 
  
  const [formData, setFormData] = useState({
    namaLengkap: '',
    namaPanggilan: '',
    skor: {
      artikulasi: 3,
      engagement: 3,
      ekspresi: 3,
      inklusivitas: 2,
      kecemasan: 3
    },
    rawNotes: '',
    nilaiAkhir: ''
  });

  const [paragraphs, setParagraphs] = useState([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const reportRef = useRef(null);

  // Memuat library html2pdf secara dinamis melalui CDN
  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    script.async = true;
    document.head.appendChild(script);
    return () => {
      if (document.head.contains(script)) {
        document.head.removeChild(script);
      }
    };
  }, []);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSkorChange = (aspek, val) => {
    setFormData(prev => ({
      ...prev,
      skor: { ...prev.skor, [aspek]: parseInt(val) }
    }));
  };

  const resetForm = () => {
    if (confirm("Apakah Anda yakin ingin menghapus semua data input?")) {
      setFormData({
        namaLengkap: '',
        namaPanggilan: '',
        skor: { artikulasi: 1, engagement: 1, ekspresi: 1, inklusivitas: 1, kecemasan: 1 },
        rawNotes: '',
        nilaiAkhir: ''
      });
      setParagraphs([]);
    }
  };

  const generateReportWithAI = async () => {
    if (!formData.rawNotes || !formData.namaPanggilan) {
      alert("Harap isi Nama Panggilan dan Observasi Mentah terlebih dahulu.");
      return;
    }

    setIsGenerating(true);
    const systemPrompt = `
      Anda adalah seorang instruktur Public Speaking profesional di YEC.CO.ID.
      Tugas Anda adalah membuat laporan observasi bulanan berdasarkan data skor dan catatan mentah.
      
      KRITERIA PENULISAN:
      1. Terdiri dari MAKSIMAL 6 paragraf.
      2. Bahasa: Indonesia, Formal, Profesional, Tajam, Kritis, Analitis, namun tetap Soft-Spoken.
      3. JANGAN mengglorifikasi atau berlebihan. Gunakan analisis berbasis data.
      4. Setiap paragraf harus mengaitkan aspek penilaian dengan indikator teknis.
      5. Sertakan contoh konkret atau analisis detail berdasarkan catatan instruktur.
      6. Paragraf terakhir harus berisi Kesimpulan dan Rekomendasi strategis.
      7. Gunakan nama panggilan saja (${formData.namaPanggilan}) tanpa embel-embel 'Ananda'.
      
      PENONJOLAN TEKS:
      Bungkus frasa penting dengan tag HTML:
      - <strong>Teks</strong> untuk tebal.
      - <span class="hl-blue">Teks</span> untuk progres/netral.
      - <span class="hl-green">Teks</span> untuk kelebihan.
      - <span class="hl-red">Teks</span> untuk area pengembangan kritis.
      - <span class="hl-yellow">Teks</span> untuk rekomendasi penting.
      
      ASPEK: Artikulasi(${formData.skor.artikulasi}), Interaction(${formData.skor.engagement}), Ekspresi(${formData.skor.ekspresi}), Inklusivitas(${formData.skor.inklusivitas}), Kecemasan(${formData.skor.kecemasan}).
      DATA MENTAH: "${formData.rawNotes}"
      
      Output JSON: { "paragraphs": ["isi paragraf 1", "isi paragraf 2", ...] }
    `;

    let retries = 0;
    const maxRetries = 5;
    
    const attemptFetch = async () => {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "Proses laporan sesuai instruksi sistem." }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
            generationConfig: { responseMimeType: "application/json" }
          })
        });

        if (!response.ok) throw new Error('API Error');
        const result = await response.json();
        const data = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || "{}");
        if (data.paragraphs) setParagraphs(data.paragraphs);
      } catch (error) {
        if (retries < maxRetries) {
          retries++;
          await new Promise(res => setTimeout(res, Math.pow(2, retries) * 1000));
          return attemptFetch();
        }
        alert("Gagal memproses data. Pastikan API Key sudah benar.");
      }
    };

    await attemptFetch();
    setIsGenerating(false);
  };

  const downloadPDF = () => {
    if (!window.html2pdf) {
      alert("Library PDF belum siap, silakan tunggu atau refresh halaman.");
      return;
    }
    const element = reportRef.current;
    const opt = {
      margin: 0,
      filename: `Report_YEC_${formData.namaPanggilan || 'Siswa'}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    window.html2pdf().set(opt).from(element).save();
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-900">
      <style>{`
        .hl-blue { background-color: #dbeafe; color: #1e40af; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        .hl-red { background-color: #fee2e2; color: #991b1b; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        .hl-green { background-color: #dcfce7; color: #166534; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        .hl-yellow { background-color: #fef9c3; color: #854d0e; padding: 0 4px; border-radius: 4px; font-weight: 600; }
        strong { font-weight: 700; color: #0f172a; }
        @media print { .no-print { display: none; } }
      `}</style>
      
      <div className="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
        
        {/* PANEL KONTROL & INPUT */}
        <div className="lg:w-1/3 space-y-6 no-print">
          <div className="flex items-center justify-between mb-2">
            <div className="flex items-center gap-2 text-blue-900 font-bold">
              <Github size={20} />
              <span>YEC Team Dashboard</span>
            </div>
            <button onClick={resetForm} className="text-slate-400 hover:text-red-500 transition-colors">
              <Trash2 size={18} />
            </button>
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-lg font-bold flex items-center gap-2 mb-6 text-slate-800">
              <User size={18} className="text-blue-500" /> Identitas Peserta
            </h2>
            <div className="space-y-4">
              <div className="group">
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Nama Lengkap</label>
                <input 
                  className="w-full mt-1 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                  name="namaLengkap" value={formData.namaLengkap} onChange={handleInputChange} placeholder="Masukkan nama lengkap..."
                />
              </div>
              <div className="group">
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Nama Panggilan</label>
                <input 
                  className="w-full mt-1 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                  name="namaPanggilan" value={formData.namaPanggilan} onChange={handleInputChange} placeholder="Nama untuk di laporan..."
                />
              </div>
              <div className="group">
                <label className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Skor Akhir (0-100)</label>
                <input 
                  type="number" className="w-full mt-1 px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                  name="nilaiAkhir" value={formData.nilaiAkhir} onChange={handleInputChange} placeholder="Contoh: 85"
                />
              </div>
            </div>
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-lg font-bold flex items-center gap-2 mb-6 text-slate-800">
              <BarChart3 size={18} className="text-blue-500" /> Matriks Penilaian
            </h2>
            <div className="space-y-5">
              {Object.keys(formData.skor).map(key => (
                <div key={key} className="flex items-center justify-between">
                  <label className="text-xs font-semibold text-slate-500 capitalize">{key}</label>
                  <div className="flex gap-1.5">
                    {[1, 2, 3, 4].map(n => (
                      <button
                        key={n}
                        onClick={() => handleSkorChange(key, n)}
                        className={`w-9 h-9 rounded-xl text-xs font-bold transition-all ${formData.skor[key] === n ? 'bg-blue-600 text-white shadow-lg shadow-blue-200 scale-110' : 'bg-slate-50 text-slate-400 hover:bg-slate-100'}`}
                      >
                        {n}
                      </button>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <h2 className="text-lg font-bold flex items-center gap-2 mb-4 text-slate-800">
              <MessageSquare size={18} className="text-blue-500" /> Observasi Instruktur
            </h2>
            <textarea 
              className="w-full px-4 py-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:ring-2 focus:ring-blue-500 h-44 resize-none leading-relaxed transition-all"
              placeholder="Contoh: Artikulasi jelas tapi volume tidak stabil. Sangat berani saat maju tapi dalam diskusi kelompok masih pasif..."
              value={formData.rawNotes} 
              onChange={(e) => setFormData({...formData, rawNotes: e.target.value})}
            />
            
            <button 
              onClick={generateReportWithAI}
              disabled={isGenerating}
              className="w-full mt-6 bg-slate-900 hover:bg-black disabled:bg-slate-300 text-white font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-3 shadow-xl transform active:scale-95"
            >
              {isGenerating ? <Loader2 className="animate-spin" size={20} /> : <Sparkles size={20} className="text-blue-400" />}
              {isGenerating ? "Sedang Mengolah..." : "Buat Elaborasi Laporan"}
            </button>
          </div>
        </div>

        {/* PRATINJAU LAPORAN */}
        <div className="flex-1 bg-white rounded-[2.5rem] overflow-hidden shadow-2xl min-h-[1150px] border border-slate-200 relative">
          
          <div className="absolute top-8 right-8 z-50 no-print flex gap-3">
             <button onClick={() => window.print()} className="bg-white text-slate-700 p-3 rounded-2xl shadow-lg hover:bg-slate-50 transition-all border border-slate-100">
                <Printer size={20} />
             </button>
             <button onClick={downloadPDF} className="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-2xl shadow-xl transition-all flex items-center gap-2 font-bold text-sm transform hover:-translate-y-1">
                <Download size={20} /> Simpan PDF
             </button>
          </div>

          <div ref={reportRef} className="relative bg-white min-h-full">
            {/* Watermark Dinamis */}
            <div className="absolute inset-0 pointer-events-none overflow-hidden flex flex-col justify-around items-center opacity-[0.03] z-0 select-none">
               {[1,2,3,4,5,6].map(i => <div key={i} className="text-[10rem] font-black -rotate-[35deg] whitespace-nowrap tracking-tighter">YEC.CO.ID</div>)}
            </div>

            <div className="relative z-10">
              {/* Desain Header */}
              <div className="bg-gradient-to-br from-[#0f172a] via-[#1e3a8a] to-[#3b82f6] p-20 text-center text-white relative">
                <div className="absolute top-0 right-0 w-96 h-96 bg-white/5 rounded-full -mr-48 -mt-48 blur-3xl"></div>
                <h1 className="text-4xl md:text-5xl font-serif font-bold mb-4 tracking-tight">Monthly Observation Report</h1>
                <div className="inline-flex items-center gap-3 px-6 py-2 bg-white/10 backdrop-blur-md rounded-full border border-white/20">
                  <span className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></span>
                  <span className="tracking-[0.25em] uppercase text-[10px] font-bold text-blue-100">Public Speaking Anak Reguler</span>
                </div>
              </div>

              {/* Data Identitas */}
              <div className="grid grid-cols-2 p-12 bg-slate-50/80 border-b border-slate-100 backdrop-blur-sm">
                <div className="border-r border-slate-200">
                  <p className="text-[9px] text-slate-400 uppercase font-black tracking-[0.2em] mb-2">Nama Lengkap Peserta</p>
                  <p className="text-2xl font-bold text-slate-800 leading-none">{formData.namaLengkap || "—"}</p>
                </div>
                <div className="pl-12">
                  <p className="text-[9px] text-slate-400 uppercase font-black tracking-[0.2em] mb-2">Nama Panggilan</p>
                  <p className="text-2xl font-bold text-blue-700 leading-none">{formData.namaPanggilan || "—"}</p>
                </div>
              </div>

              {/* Konten Penilaian */}
              <div className="p-12">
                <div className="flex items-center gap-4 mb-10">
                  <div className="h-10 w-1.5 bg-blue-600 rounded-full"></div>
                  <h2 className="font-serif text-2xl font-bold text-slate-800">Matriks Capaian Kompetensi</h2>
                </div>

                <div className="grid grid-cols-1 gap-7">
                  {Object.entries({
                    "Artikulasi & Proyeksi Suara": formData.skor.artikulasi,
                    "Interaksi & Respons (Engagement)": formData.skor.engagement,
                    "Ekspresi & Penguasaan Ruang": formData.skor.ekspresi,
                    "Inklusivitas & Kontrol Kelompok": formData.skor.inklusivitas,
                    "Manajemen Kecemasan": formData.skor.kecemasan,
                  }).map(([label, val]) => (
                    <div key={label} className="group">
                      <div className="flex justify-between mb-2 items-end">
                        <span className="text-xs font-bold text-slate-500 uppercase tracking-tighter group-hover:text-blue-600 transition-colors">{label}</span>
                        <span className="text-xs font-black bg-white border border-slate-200 px-3 py-1 rounded-lg shadow-sm">{val} <span className="text-slate-300">/ 4</span></span>
                      </div>
                      <div className="w-full bg-slate-100 rounded-full h-3 border border-slate-100 p-0.5 overflow-hidden">
                        <div 
                          className={`h-full rounded-full transition-all duration-1000 ease-out ${val === 4 ? 'bg-emerald-500' : val === 3 ? 'bg-blue-500' : val === 2 ? 'bg-yellow-500' : 'bg-red-500'}`} 
                          style={{ width: `${(val/4)*100}%` }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-14 bg-gradient-to-r from-blue-50 to-indigo-50 p-10 rounded-[2rem] flex items-center justify-between border border-blue-100 shadow-inner">
                  <div className="space-y-1">
                    <p className="text-[10px] font-black text-blue-400 uppercase tracking-widest">Akumulasi Skor Bulanan</p>
                    <span className="text-blue-900 font-bold text-2xl uppercase italic tracking-tight">Evaluasi Akhir Sesi</span>
                  </div>
                  <div className="text-right">
                    <span className="text-7xl font-black text-blue-900 tracking-tighter">{formData.nilaiAkhir || "0"}<span className="text-2xl font-light text-blue-300 ml-2">/100</span></span>
                  </div>
                </div>
              </div>

              {/* Elaborasi Narasi AI */}
              <div className="p-12 bg-white border-t border-slate-100">
                <div className="flex items-center gap-4 mb-10">
                  <div className="h-10 w-1.5 bg-blue-600 rounded-full"></div>
                  <h2 className="font-serif text-2xl font-bold text-slate-800">Analisis Kualitatif & Rekomendasi</h2>
                </div>
                
                {isGenerating ? (
                  <div className="flex flex-col items-center justify-center py-32 text-slate-300 animate-pulse">
                    <Sparkles size={60} className="mb-6 opacity-20" />
                    <p className="text-sm font-bold tracking-widest uppercase">Menganalisis Data Observasi...</p>
                  </div>
                ) : (
                  <div className="space-y-10 text-slate-600 text-[15.5px] leading-[1.95] text-justify font-light">
                    {paragraphs.length > 0 ? paragraphs.map((para, idx) => (
                      <p key={idx} className="relative pl-8 before:content-[''] before:absolute before:left-0 before:top-3.5 before:w-2 before:h-2 before:bg-blue-200 before:rounded-full" 
                         dangerouslySetInnerHTML={{ __html: para }} 
                      />
                    )) : (
                      <div className="py-20 text-center border-2 border-dashed border-slate-100 rounded-[2rem]">
                        <p className="italic text-slate-400">Belum ada narasi. Silakan masukkan catatan instruktur dan tekan tombol 'Buat Elaborasi'.</p>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Tanda Tangan & Footer */}
              <div className="p-20 bg-slate-50 border-t border-slate-100 flex flex-col md:flex-row justify-between items-end gap-12">
                <div className="space-y-5">
                  <div className="flex items-center gap-3 text-blue-600 bg-white px-4 py-2 rounded-2xl shadow-sm inline-flex">
                    <CheckCircle2 size={18} />
                    <span className="text-[10px] font-bold uppercase tracking-[0.2em]">Verified Academic Report</span>
                  </div>
                  <p className="text-[11px] text-slate-400 italic max-w-sm leading-relaxed">
                    Dokumen ini dihasilkan secara otomatis melalui sistem evaluasi instruktur YEC.CO.ID untuk mendukung transparansi perkembangan bakat komunikasi anak.
                  </p>
                </div>
                <div className="text-center group min-w-[220px]">
                  <div className="mb-6 h-12 flex items-center justify-center opacity-10 group-hover:opacity-100 transition-opacity">
                    <span className="font-serif text-slate-400 text-sm">Digital Signature Attached</span>
                  </div>
                  <div className="w-full h-px bg-slate-300 mb-4"></div>
                  <p className="text-[11px] font-black text-slate-700 uppercase tracking-[0.25em]">Instruktur Public Speaking</p>
                  <p className="text-[9px] text-slate-400 mt-2 font-bold">YEC.CO.ID PROFESSIONAL EDUCATION</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
